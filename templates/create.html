{% extends "base.html" %}

{% block title %}Create {{ create_type|title }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white shadow-2xl rounded-2xl p-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">
                Create New {{ create_type|title }}
            </h1>
            <div class="space-x-4">
                <a href="{{ url_for('create', type='poll') }}" 
                   class="px-4 py-2 rounded-lg {% if create_type == 'poll' %}bg-indigo-600 text-white{% else %}bg-gray-100 text-gray-700{% endif %} hover:opacity-90">
                    Create Poll
                </a>
                <a href="{{ url_for('create', type='survey') }}"
                   class="px-4 py-2 rounded-lg {% if create_type == 'survey' %}bg-purple-600 text-white{% else %}bg-gray-100 text-gray-700{% endif %} hover:opacity-90">
                    Create Survey
                </a>
            </div>
        </div>

        {% if create_type == 'poll' %}
            <form method="post" class="space-y-8" id="pollForm" enctype="multipart/form-data">
                <div class="space-y-2 group">
                    <label for="question" class="block text-lg font-semibold text-gray-900">What's your question?</label>
                    <input type="text" name="question" id="question" required minlength="5"
                           placeholder="Enter your question here..."
                           class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm 
                                  focus:border-indigo-500 focus:ring-indigo-500 transition-all
                                  group-hover:border-indigo-300 text-lg py-3">
                    <p class="text-sm text-gray-500">Must be at least 5 characters long</p>
                </div>

                <div class="space-y-4">
                    <label class="block text-lg font-semibold text-gray-900">Response Type</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none">
                            <input type="radio" name="question_type" value="mcq" class="peer sr-only" checked 
                                   onchange="showQuestionOptions('mcq')">
                            <div class="flex w-full items-center justify-between">
                                <div>
                                    <p class="text-gray-900 font-medium">Multiple Choice</p>
                                    <p class="text-gray-500 text-sm">Create options to choose from</p>
                                </div>
                                <svg class="h-5 w-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div class="absolute -inset-px rounded-lg border-2 pointer-events-none peer-checked:border-indigo-500"></div>
                        </label>

                        <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none">
                            <input type="radio" name="question_type" value="rating" class="peer sr-only"
                                   onchange="showQuestionOptions('rating')">
                            <div class="flex w-full items-center justify-between">
                                <div>
                                    <p class="text-gray-900 font-medium">Rating Scale</p>
                                    <p class="text-gray-500 text-sm">Rate on a scale</p>
                                </div>
                                <svg class="h-5 w-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                                </svg>
                            </div>
                            <div class="absolute -inset-px rounded-lg border-2 pointer-events-none peer-checked:border-indigo-500"></div>
                        </label>

                        <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none">
                            <input type="radio" name="question_type" value="text" class="peer sr-only"
                                   onchange="showQuestionOptions('text')">
                            <div class="flex w-full items-center justify-between">
                                <div>
                                    <p class="text-gray-900 font-medium">Text Answer</p>
                                    <p class="text-gray-500 text-sm">Free form response</p>
                                </div>
                                <svg class="h-5 w-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                            </div>
                            <div class="absolute -inset-px rounded-lg border-2 pointer-events-none peer-checked:border-indigo-500"></div>
                        </label>
                    </div>
                </div>

                <div id="mcqOptions" class="question-options space-y-6">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <label class="block text-lg font-semibold text-gray-900">Poll Options</label>
                            <button type="button" id="addOption" 
                                    class="text-indigo-600 hover:text-indigo-800 flex items-center space-x-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                                <span>Add Option</span>
                            </button>
                        </div>
                        <div id="optionsContainer" class="space-y-3">
                            <div class="option-input group animate__animated animate__fadeIn">
                                <div class="flex items-center space-x-2">
                                    <span class="text-gray-400 option-number">1.</span>
                                    <input type="text" name="options" required placeholder="Enter option..."
                                           class="flex-1 rounded-lg border-gray-300 shadow-sm 
                                                  focus:border-indigo-500 focus:ring-indigo-500
                                                  group-hover:border-indigo-300">
                                </div>
                            </div>
                            <div class="option-input group animate__animated animate__fadeIn">
                                <div class="flex items-center space-x-2">
                                    <span class="text-gray-400 option-number">2.</span>
                                    <input type="text" name="options" required placeholder="Enter option..."
                                           class="flex-1 rounded-lg border-gray-300 shadow-sm 
                                                  focus:border-indigo-500 focus:ring-indigo-500
                                                  group-hover:border-indigo-300">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border-t pt-6">
                        <label class="block text-lg font-semibold text-gray-900 mb-4">Selection Type</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none">
                                <input type="radio" name="selection_type" value="single" class="peer sr-only" checked>
                                <div class="flex w-full items-center justify-between">
                                    <div>
                                        <p class="text-gray-900 font-medium">Single Choice</p>
                                        <p class="text-gray-500 text-sm">One option only</p>
                                    </div>
                                    <svg class="h-5 w-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="absolute -inset-px rounded-lg border-2 pointer-events-none peer-checked:border-indigo-500"></div>
                            </label>

                            <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none">
                                <input type="radio" name="selection_type" value="multiple" class="peer sr-only">
                                <div class="flex w-full items-center justify-between">
                                    <div>
                                        <p class="text-gray-900 font-medium">Multiple Choice</p>
                                        <p class="text-gray-500 text-sm">Multiple options allowed</p>
                                    </div>
                                    <svg class="h-5 w-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="absolute -inset-px rounded-lg border-2 pointer-events-none peer-checked:border-indigo-500"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="ratingOptions" class="question-options hidden">
                    <div class="space-y-2">
                        <label for="rating_scale" class="block text-lg font-semibold text-gray-900">Rating Scale</label>
                        <select name="rating_scale" id="rating_scale" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="5">1-5 Scale</option>
                            <option value="10">1-10 Scale</option>
                        </select>
                    </div>
                </div>

                <div id="textOptions" class="question-options hidden">
                    <p class="text-gray-500">Participants will be able to provide a free-form text answer.</p>
                </div>

                <input type="hidden" name="multiple_votes" id="multiple_votes" value="false">
                
                <script>
                    document.querySelectorAll('input[name="poll_type"]').forEach(radio => {
                        radio.addEventListener('change', function() {
                            document.getElementById('multiple_votes').value = this.value === 'multiple';
                        });
                    });

                    function showQuestionOptions(type) {
                        document.querySelectorAll('.question-options').forEach(el => {
                            el.classList.add('hidden');
                        });
                        
                        const selectedSection = document.getElementById(type + 'Options');
                        if (selectedSection) {
                            selectedSection.classList.remove('hidden');
                        }
                        
                        const pollTypeSection = document.querySelector('.poll-type-section');
                        if (pollTypeSection) {
                            pollTypeSection.classList.toggle('hidden', type !== 'mcq');
                        }
                    }

                    const initialType = document.querySelector('input[name="question_type"]:checked').value;
                    showQuestionOptions(initialType);

                    document.querySelectorAll('input[name="question_type"]').forEach(radio => {
                        radio.addEventListener('change', (e) => {
                            showQuestionOptions(e.target.value);
                        });
                    });

                    document.addEventListener('DOMContentLoaded', function() {
                        const optionsContainer = document.getElementById('optionsContainer');
                        const addOptionBtn = document.getElementById('addOption');
                        const maxOptions = 10;

                        function updateOptionNumbers() {
                            document.querySelectorAll('.option-number').forEach((span, index) => {
                                span.textContent = `${index + 1}.`;
                            });
                        }

                        function createOptionInput() {
                            const optionCount = optionsContainer.children.length;
                            if (optionCount >= maxOptions) {
                                alert('Maximum 10 options allowed');
                                return;
                            }

                            const div = document.createElement('div');
                            div.className = 'option-input group animate__animated animate__fadeIn';
                            div.innerHTML = `
                                <div class="flex items-center space-x-2">
                                    <span class="text-gray-400 option-number">${optionCount + 1}.</span>
                                    <input type="text" name="options" placeholder="Enter option..."
                                        class="flex-1 rounded-lg border-gray-300 shadow-sm 
                                            focus:border-indigo-500 focus:ring-indigo-500
                                            group-hover:border-indigo-300">
                                    <button type="button" class="text-red-500 hover:text-red-700 delete-option">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            `;

                            optionsContainer.appendChild(div);
                        }

                        addOptionBtn.addEventListener('click', createOptionInput);

                        optionsContainer.addEventListener('click', function(e) {
                            if (e.target.closest('.delete-option')) {
                                const optionInput = e.target.closest('.option-input');
                                if (optionsContainer.children.length > 2) {
                                    optionInput.classList.remove('animate__fadeIn');
                                    optionInput.classList.add('animate__fadeOut');
                                    setTimeout(() => {
                                        optionInput.remove();
                                        updateOptionNumbers();
                                    }, 500);
                                } else {
                                    alert('Minimum 2 options required');
                                }
                            }
                        });

                        document.getElementById('image').addEventListener('change', function(e) {
                            const preview = document.getElementById('image-preview');
                            const file = e.target.files[0];
                            
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    preview.querySelector('img').src = e.target.result;
                                    preview.classList.remove('hidden');
                                }
                                reader.readAsDataURL(file);
                            } else {
                                preview.classList.add('hidden');
                            }
                        });

                        document.getElementById('pollForm').addEventListener('submit', function(e) {
                            const options = Array.from(document.getElementsByName('options'))
                                                .map(input => input.value.trim())
                                                .filter(value => value.length > 0);

                            if (new Set(options).size !== options.length) {
                                e.preventDefault();
                                showToast('All options must be unique', 'error');
                                return;
                            }
                        });
                    });
                </script>
                <div class="space-y-2">
                    <label for="image" class="block text-lg font-semibold text-gray-900">Poll Image (optional)</label>
                    <input type="file" name="image" id="image" accept="image/*"
                           class="block w-full text-sm text-gray-500
                                  file:mr-4 file:py-2 file:px-4
                                  file:rounded-full file:border-0
                                  file:text-sm file:font-semibold
                                  file:bg-indigo-50 file:text-indigo-700
                                  hover:file:bg-indigo-100">
                    <p class="text-sm text-gray-500">Supported formats: PNG, JPG, JPEG, GIF, WEBP (max 16MB)</p>
                    <div id="image-preview" class="hidden mt-2">
                        <img src="" alt="Preview" class="max-h-48 rounded-lg">
                    </div>
                </div>

                <div class="bg-gray-50 rounded-xl p-6 space-y-6">
                    <h3 class="text-lg font-semibold text-gray-900">Advanced Settings</h3>
                    
                    <div class="space-y-4">
                        <div class="space-y-2">
                            <label for="start_date" class="flex items-center space-x-2 text-gray-700">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                <span>Poll Start Date (optional)</span>
                            </label>
                            <input type="datetime-local" name="start_date" id="start_date"
                                   class="w-full rounded-lg border-gray-300 shadow-sm 
                                          focus:border-indigo-500 focus:ring-indigo-500">
                            <p class="text-sm text-gray-500">If set, the poll will only be accessible after this date</p>
                        </div>

                        <div class="space-y-2">
                            <label for="expires_at" class="flex items-center space-x-2 text-gray-700">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span>Poll Expiration (optional)</span>
                            </label>
                            <input type="datetime-local" name="expires_at" id="expires_at"
                                   class="w-full rounded-lg border-gray-300 shadow-sm 
                                          focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" name="private" id="private"
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="private" class="text-gray-700 flex items-center space-x-2">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                </svg>
                                <span>Make this poll private (accessible only via special link)</span>
                            </label>
                        </div>

                        <div class="space-y-2">
                            <label for="password" class="flex items-center space-x-2 text-gray-700">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                                </svg>
                                <span>Password Protection (optional)</span>
                            </label>
                            <input type="password" name="password" id="password"
                                   placeholder="Enter password to restrict access"
                                   class="w-full rounded-lg border-gray-300 shadow-sm 
                                          focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between pt-6">
                    <a href="{{ url_for('index') }}" 
                       class="text-gray-600 hover:text-gray-800 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        <span>Cancel</span>
                    </a>
                    <div class="flex space-x-4">
                        <button type="submit" formaction="{{ url_for('preview_poll') }}" formtarget="_blank"
                                class="bg-indigo-50 text-indigo-600 px-6 py-3 rounded-xl hover:bg-indigo-100
                                       flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            <span>Preview</span>
                        </button>
                        <button type="submit" 
                                class="gradient-bg text-white px-8 py-3 rounded-xl hover-scale shadow-lg
                                       flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Create Poll</span>
                        </button>
                    </div>
                </div>
            </form>
        {% else %}
    <form method="post" class="space-y-8" id="surveyForm" enctype="multipart/form-data">
        <div class="space-y-2">
            <label for="title" class="block text-lg font-semibold text-gray-900">Survey Title</label>
            <input type="text" name="title" id="title" required minlength="5"
                   placeholder="Enter survey title..."
                   class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm 
                          focus:border-indigo-500 focus:ring-indigo-500 text-lg py-3">
        </div>

        <div class="space-y-2">
            <label for="description" class="block text-lg font-semibold text-gray-900">Description (optional)</label>
            <textarea name="description" id="description" rows="3"
                      class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm 
                             focus:border-indigo-500 focus:ring-indigo-500"></textarea>
        </div>

        <div id="questions" class="space-y-6">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button type="button" onclick="addQuestion('mcq')" 
                    class="border-2 border-dashed border-indigo-300 text-indigo-600 rounded-xl p-4 
                           hover:bg-indigo-50 transition-colors flex flex-col items-center justify-center space-y-2">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>Add Multiple Choice</span>
            </button>

            <button type="button" onclick="addQuestion('rating')"
                    class="border-2 border-dashed border-purple-300 text-purple-600 rounded-xl p-4 
                           hover:bg-purple-50 transition-colors flex flex-col items-center justify-center space-y-2">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                </svg>
                <span>Add Rating Question</span>
            </button>

            <button type="button" onclick="addQuestion('text')"
                    class="border-2 border-dashed border-emerald-300 text-emerald-600 rounded-xl p-4 
                           hover:bg-emerald-50 transition-colors flex flex-col items-center justify-center space-y-2">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                <span>Add Text Question</span>
            </button>
        </div>

        <input type="hidden" name="questions" id="questionsData">

        <div class="flex justify-between pt-6">
            <a href="{{ url_for('index') }}" class="text-gray-600 hover:text-gray-800">Cancel</a>
            <button type="submit" 
                    class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale">
                Create Survey
            </button>
        </div>
    </form>
{% endif %}
</div>
</div>

<script>
    {% if create_type == 'poll' %}
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelector('.poll-type-section').classList.add('hidden');

            function showQuestionOptions(type) {
                document.querySelectorAll('.question-options').forEach(el => el.classList.add('hidden'));
                
                const selectedSection = document.getElementById(type + 'Options');
                if (selectedSection) {
                    selectedSection.classList.remove('hidden');
                }
                
                const pollTypeSection = document.querySelector('.poll-type-section');
                pollTypeSection.classList.toggle('hidden', type !== 'mcq');
                
                const optionInputs = document.querySelectorAll('input[name="options"]');
                optionInputs.forEach(input => {
                    input.required = (type === 'mcq');
                });
            }

            const initialType = document.querySelector('input[name="question_type"]:checked').value;
            showQuestionOptions(initialType);

            document.querySelectorAll('input[name="question_type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    showQuestionOptions(e.target.value);
                });
            });

            document.querySelectorAll('input[name="selection_type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('multiple_votes').value = this.value === 'multiple';
                });
            });

            document.getElementById('pollForm').addEventListener('submit', function(e) {
                const questionType = document.querySelector('input[name="question_type"]:checked').value;
                
                if (questionType === 'mcq') {
                    const options = Array.from(document.getElementsByName('options'))
                                        .map(input => input.value.trim())
                                        .filter(value => value.length > 0);

                    if (options.length < 2) {
                        e.preventDefault();
                        showToast('Please provide at least 2 options for multiple choice questions', 'error');
                        return;
                    }

                    if (new Set(options).size !== options.length) {
                        e.preventDefault();
                        showToast('All options must be unique', 'error');
                        return;
                    }
                }
            });
        });
    {% else %}
    function addQuestion(type) {
        const questionsContainer = document.getElementById('questions');
        const questionDiv = document.createElement('div');
        const questionId = Date.now();
        questionDiv.className = 'bg-gray-50 rounded-xl p-6 space-y-4 animate__animated animate__fadeIn';
        questionDiv.dataset.questionId = questionId;
        questionDiv.dataset.type = type;
        
        let content = `
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1 mr-4">
                    <input type="text" placeholder="Enter your question..."
                           class="w-full rounded-lg border-gray-300 shadow-sm 
                                  focus:border-indigo-500 focus:ring-indigo-500 text-lg"
                           onchange="updateQuestionData()">
                </div>
                <button type="button" onclick="removeQuestion(this)" 
                        class="text-red-500 hover:text-red-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
            </div>
        `;

        switch(type) {
            case 'mcq':
                content += createMCQContent();
                break;
            case 'rating':
                content += createRatingContent();
                break;
            case 'text':
                content += createTextContent();
                break;
        }
        
        questionDiv.innerHTML = content;
        questionsContainer.appendChild(questionDiv);
        updateQuestionData();
    }

    function createMCQContent() {
        return `
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <label class="text-gray-700 font-medium">Options</label>
                    <button type="button" onclick="addMCQOption(this)" 
                            class="text-indigo-600 hover:text-indigo-800 text-sm">
                        Add Option
                    </button>
                </div>
                <div class="mcq-options space-y-2">
                    <input type="text" placeholder="Option 1" 
                           class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                           onchange="updateQuestionData()">
                    <input type="text" placeholder="Option 2" 
                           class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                           onchange="updateQuestionData()">
                </div>
                <label class="inline-flex items-center">
                    <input type="checkbox" class="text-indigo-600 border-gray-300 rounded"
                           onchange="updateQuestionData()">
                    <span class="ml-2">Allow multiple selections</span>
                </label>
            </div>
        `;
    }

    function createRatingContent() {
        return `
            <div class="space-y-4">
                <select class="rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                        onchange="updateQuestionData()">
                    <option value="5">1-5 Scale</option>
                    <option value="10">1-10 Scale</option>
                </select>
            </div>
        `;
    }

    function createTextContent() {
        return `
            <div class="space-y-4">
                <p class="text-gray-500">Participants will provide a text answer.</p>
            </div>
        `;
    }

    function addMCQOption(button) {
        const optionsContainer = button.closest('.space-y-4').querySelector('.mcq-options');
        const optionCount = optionsContainer.children.length;
        
        if (optionCount >= 10) {
            showToast('Maximum 10 options allowed', 'error');
            return;
        }

        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = `Option ${optionCount + 1}`;
        input.className = 'w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500';
        input.onchange = updateQuestionData;
        
        optionsContainer.appendChild(input);
    }

    function removeQuestion(button) {
        const questionDiv = button.closest('[data-question-id]');
        questionDiv.classList.remove('animate__fadeIn');
        questionDiv.classList.add('animate__fadeOut');
        setTimeout(() => {
            questionDiv.remove();
            updateQuestionData();
        }, 500);
    }

    function updateQuestionData() {
        const questions = [];
        document.querySelectorAll('[data-question-id]').forEach(questionDiv => {
            const question = {
                question: questionDiv.querySelector('input[type="text"]').value.trim(),
                type: questionDiv.dataset.type,
                options: [],
                multiple_votes: false,
                rating_scale: 5
            };

            if (question.type === 'mcq') {
                questionDiv.querySelectorAll('.mcq-options input').forEach(input => {
                    if (input.value.trim()) {
                        question.options.push(input.value.trim());
                    }
                });
                question.multiple_votes = questionDiv.querySelector('input[type="checkbox"]').checked;
            } else if (question.type === 'rating') {
                question.rating_scale = parseInt(questionDiv.querySelector('select').value);
            }

            questions.push(question);
        });

        document.getElementById('questionsData').value = JSON.stringify(questions);
    }

    document.addEventListener('DOMContentLoaded', function() {
        addQuestion('mcq');

        document.getElementById('surveyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('title').value.trim();
            if (title.length < 5) {
                showToast('Survey title must be at least 5 characters long', 'error');
                return;
            }

            const questions = JSON.parse(document.getElementById('questionsData').value);
            if (questions.length === 0) {
                showToast('Please add at least one question', 'error');
                return;
            }

            for (let q of questions) {
                if (q.question.length < 5) {
                    showToast('All questions must be at least 5 characters long', 'error');
                    return;
                }
                if (q.type === 'mcq') {
                    const validOptions = q.options.filter(opt => opt.trim().length > 0);
                    if (validOptions.length < 2) {
                        showToast('Multiple choice questions must have at least 2 options', 'error');
                        return;
                    }
                }
            }

            this.submit();
        });
    });
    {% endif %}
</script>
{% endblock %}
